#!/bin/bash

echo "ðŸ” Scanning for orphaned development processes..."

# 1. ä½œæ¥­ç³»çµ±åµæ¸¬
OS="$(uname -s)"

# 2. å®šç¾©é€šç”¨çš„å­¤å…’é€²ç¨‹ç‰¹å¾µ (å¯è¼•æ˜“æ“´å……)
# åŒ…å«å¸¸è¦‹çš„ç¾ä»£ AI é–‹ç™¼å·¥å…· (MCP)ã€å‰ç«¯å·¥å…·èˆ‡è·¨å¹³å°é–‹ç™¼å·¥å…·
ORPHAN_PATTERNS=(
  # AI & MCP Servers (Common)
  "mcp-server|playwright-mcp"
  # AI & MCP Servers (Personal / Custom)
  "context7|mobile-mcp"
  # Node.js Wrappers
  "npm exec @playwright|npm exec @mobilenext|npm exec @upstash"
  # Dart & Flutter Tooling
  "flutter_tester|dart.*(tooling-daemon|devtools --machine|development-service)"
  # iOS Logging
  "log stream.*Runner"
)

# å°‡é™£åˆ—çµ„åˆæˆæ­£å‰‡è¡¨é”å¼å­—ä¸²
REGEX_PATTERN=$(IFS="|"; echo "${ORPHAN_PATTERNS[*]}")

# 3. å°‹æ‰¾å®‰å…¨çš„å­¤å…’é€²ç¨‹ (PPID=1)
ORPHAN_PIDS=$(ps -eo ppid,pid,command | grep -E "$REGEX_PATTERN" | grep -v grep | awk '$1 == 1 {print $2}')
# é‡å°ç‰¹å®šå¸¸å¸¸æ®˜ç•™çš„å‘½ä»¤ (ä¾‹å¦‚ adb logcat)
ADB_PIDS=$(ps aux | grep -E 'adb.*logcat' | grep -v grep | awk '{print $2}')

# åˆä½µéœ€è¦å®‰å…¨æ¸…ç†çš„ PID
PIDS_TO_KILL=""
[ -n "$ORPHAN_PIDS" ] && PIDS_TO_KILL="$ORPHAN_PIDS"
[ -n "$ADB_PIDS" ] && PIDS_TO_KILL="$PIDS_TO_KILL $ADB_PIDS"
PIDS_TO_KILL=$(echo "$PIDS_TO_KILL" | xargs)

# é€šç”¨è¨ˆç®—èˆ‡æ¸…ç†å‡½å¼ï¼Œç›¸å®¹ macOS (Darwin) èˆ‡ Linux 
kill_and_report() {
    local PIDS=$1
    local LABEL=$2
    
    if [ -n "$PIDS" ]; then
        # ps -o rss= å–å¾—è¨˜æ†¶é«” (KB)ï¼Œåœ¨ Linux èˆ‡ macOS çš†å¯é‹ä½œ
        local STATS=$(ps -o rss= -p $PIDS 2>/dev/null | awk '{sum+=$1; count++} END {printf "%d|%.2f", count, sum/1024}')
        local COUNT=$(echo "$STATS" | cut -d'|' -f1)
        local MEM=$(echo "$STATS" | cut -d'|' -f2)
        
        echo "ðŸ”ª Killing $COUNT $LABEL (Reclaiming ~$MEM MB)..."
        echo "$PIDS" | xargs kill 2>/dev/null
    else
        echo "âœ… No $LABEL found."
    fi
}

if [ -n "$PIDS_TO_KILL" ]; then
    kill_and_report "$PIDS_TO_KILL" "orphaned/stale processes"
    echo "âœ… Safe orphans cleaned."
else
    echo "âœ… No safe orphans found. Clean!"
fi

# 4. æ·±åº¦æ¸…ç†æ¨¡å¼
if [ "$1" == "--deep" ]; then
    echo ""
    echo "âš ï¸ Deep cleanup requested..."
    
    # å»ºç«‹ä¸€å€‹å‡½å¼ä¾†è¨ˆç®—å’Œæ¸…ç†ç‰¹å®šé—œéµå­—çš„é€²ç¨‹
    cleanup_by_name() {
        local label=$1
        local pattern=$2
        local PIDS=$(ps aux | grep -E "$pattern" | grep -v grep | awk '{print $2}' | xargs)
        kill_and_report "$PIDS" "$label processes"
    }

    # è·¨å¹³å°é€šç”¨çš„æ·±åº¦æ¸…ç† (Android, Java, Flutter ç­‰)
    cleanup_by_name "Kotlin LSP" "kotlinLsp"
    cleanup_by_name "Gradle Daemon" "org.gradle.launcher.daemon"
    cleanup_by_name "Flutter Daemon" "flutter_tools.snapshot daemon"
    cleanup_by_name "Stuck xcodebuild" "xcodebuild"
    
    # macOS å°ˆç”¨çš„ iOS æ¨¡æ“¬å™¨æ¸…ç†
    if [ "$OS" == "Darwin" ] && command -v xcrun &> /dev/null; then
        SIM_PIDS=$(ps aux | grep -E 'CoreSimulator|Simulator.app' | grep -v grep | awk '{print $2}' | xargs)
        if [ -n "$SIM_PIDS" ]; then
            S_STATS=$(ps -o rss= -p $SIM_PIDS 2>/dev/null | awk '{sum+=$1; count++} END {printf "%d|%.2f", count, sum/1024}')
            S_COUNT=$(echo "$S_STATS" | cut -d'|' -f1)
            S_MEM=$(echo "$S_STATS" | cut -d'|' -f2)
            echo "ðŸ”ª Shutting down iOS Simulators ($S_COUNT processes, Reclaiming ~$S_MEM MB)..."
            xcrun simctl shutdown all 2>/dev/null
        else
            echo "âœ… No iOS Simulator processes found."
        fi
    fi
    
    echo "âœ… Deep cleanup completed."
else
    echo ""
    echo "ðŸ’¡ Tip: Run 'clean-orphans --deep' to also kill heavy background processes like Gradle, Kotlin LSP, and iOS Simulators."
fi
